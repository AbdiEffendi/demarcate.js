/*************************************************************************
*      DemarcateJS is an in-place Markdown editor and decoder            *
*                                                                        *
*      It was written by William Hart (http://www.williamhart.info) to   *
*      run on "textr" (http://to-textr.com/) a new Markdown enabled      *
*      platform to allow writing and sharing of online text              *
*                                                                        *
*                                                                        *
*      This code is provided under a GPLv3 License                       *
*               http://www.gnu.org/licenses/gpl-3.0.html                 *
*      It is also hosted at github:                                      *
*               http://will-hart.github.com/demarcate                    *
*      Contributions welcome.                                            *
*                                                                        *
*************************************************************************/

function stripHTML(e){return strippedText=$("<div/>").html(e).text()}function demarkdown(e,t){t=t||false;var n=e.get(0);var r=n.tagName;var i=n.nodeType;var s="";if(!demarcate_whitelist.contains(r)&&i!=3){return""}if(!t||r=="A"){s=line_starts[r]==undefined?"":line_starts[r]}if(i==3){s+=$.trim(n.nodeValue)}$.each(e.contents(),function(e,n){s+=demarkdown($(n),t)});if(!t||r=="A"){s+=line_ends[e.get(0).tagName]==undefined?"":line_ends[r]}if(r=="A"){s=" "+s+"("+e.attr("href")+") "}return s}function generate_toolbar(){var e=$("<div />",{id:"demarcate_toolbar"});e.append($("<a />",{id:"demarcate_h1","class":"demarcate_style",text:"H1",href:"#"}));e.append($("<a />",{id:"demarcate_h2","class":"demarcate_style",text:"H2",href:"#"}));e.append($("<a />",{id:"demarcate_h3","class":"demarcate_style",text:"H3",href:"#"}));e.append($("<a />",{id:"demarcate_h4","class":"demarcate_style",text:"H4",href:"#"}));e.append($("<a />",{id:"demarcate_h5","class":"demarcate_style",text:"H5",href:"#"}));e.append($("<a />",{id:"demarcate_h6","class":"demarcate_style",text:"H6",href:"#"}));e.append($("<a />",{id:"demarcate_p","class":"demarcate_style",text:"P",href:"#"}));e.append($("<a />",{id:"demarcate_code","class":"demarcate_style",text:"CODE",href:"#"}));e.append($("<a />",{id:"demarcate_cancel",text:"Cancel",href:"#"}));e.append($("<a />",{id:"demarcate_save",text:"Save",href:"#"}));return e}function toolbar_set_active(){var e="";if(current_demarcate_element==null){return}else{e=current_demarcate_element.get(0).tagName}$(".demarcate_style").removeClass("active");$("#demarcate_"+e.toLowerCase()).addClass("active")}function display_editor(e){e=$(e);var t=e.get(0).tagName;if(editor_whitelist.contains(t.toLowerCase())){var n=demarkdown(e,true);var r=$("<textarea id='demarcate'></textarea>");var i=generate_toolbar();e.after(r);e.after(i);e.addClass("demarcate_hide");if(typeof e.autosize!=undefined){r.autosize({append:"\n"})}current_demarcate_element=e;current_demarcate_editor=r;toolbar_set_active();r.focus().val($.trim(n))}}function hide_editor(e){e.preventDefault();$("div#demarcate_toolbar").remove();current_demarcate_editor.remove();current_demarcate_editor=null;if(current_demarcate_element.html()===""){current_demarcate_element.remove()}current_demarcate_element.removeClass("demarcate_hide");current_demarcate_element=null;$(".demarcate_temporary").remove()}function demarcate_click_elsewhere_save(e){if(current_demarcate_editor==null)return;var t=$("#demarcate_toolbar");if(!current_demarcate_editor.is(e.target)&&!t.is(e.target)&&t.has(e.target).length===0){$("#demarcate_save").click()}}function enable_demarcate_toolbar_handlers(){$(document).on("keydown","#demarcate",function(e){if(e.keyCode==13){e.preventDefault();if(!e.shiftKey){$("#demarcate_save").click()}else{var t=$("<p/>");t.insertAfter(current_demarcate_element);$("#demarcate_save").click();t.addClass("demarcate_temporary");t.click()}}});$(document).bind("mousedown",demarcate_click_elsewhere_save);$(document).on("click","#demarcate_cancel",function(e){hide_editor(e);$(document).trigger("demarcate_editor_closed",[current_demarcate_element])});$(document).on("click","#demarcate_save",function(e){current_demarcate_element.html(stripHTML(current_demarcate_editor.val()));current_demarcate_element.removeClass("demarcate_temporary");hide_editor(e);$(document).trigger("demarcate_editor_closed",[current_demarcate_element])});$(document).on("click",".demarcate_style",function(e){e.preventDefault();var t=$(this).attr("id").replace("demarcate_","");if(editor_whitelist.contains(t)){var n=$("<"+t+"></"+t+">");current_demarcate_element.after(n);current_demarcate_element.remove();current_demarcate_element=n;$("a#demarcate_cancel").fadeOut("fast",function(){this.remove()});toolbar_set_active();current_demarcate_editor.focus()}else{console.log("Unknown or disallowed tag type - "+t+". Aborting tag change.")}})}if(!Array.indexOf){Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++){if(this[t]==e){return t}}return-1}}Array.prototype.contains=function(e){return this.indexOf(e)>=0};var demarcate_whitelist=["DIV","SPAN","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE","PRE","CODE","A","P","UL","OL","HR"];var editor_whitelist=["h1","h2","h3","h4","h5","h6","li","blockquote","pre","code","p"];var line_starts={H1:"# ",H2:"## ",H3:"### ",H4:"#### ",H5:"##### ",H6:"###### ",LI:" - ",BLOCKQUOTE:"> ",PRE:"    ",CODE:"    ",A:"[",HR:"\n---------------------\n\n"};var line_ends={H1:"\n\n",H2:"\n\n",H3:"\n\n",H4:"\n\n",H5:"\n\n",H6:"\n\n",LI:"\n",BLOCKQUOTE:"\n\n",PRE:"\n\n",CODE:"\n\n",A:"]",P:"\n\n",DIV:"\n\n"};var include_internal=["H1","H2","H3","H4","H5","H6","P","BLOCKQUOTE","A"];(function(e){e.fn.demarcate=function(){result=demarkdown(this);e(document).trigger("demarcation_complete",[result]);return result}})(jQuery);(function(e){e.fn.enable_demarcate=function(){window.demarcate_dom_root=e(this);window.current_demarcate_editor=null;window.current_demarcate_element=null;len=editor_whitelist.length;for(var t=0;t<len;t++){live_selector="#"+this.attr("id")+" "+editor_whitelist[t];e(document).on("click",live_selector,function(){display_editor(this)})}enable_demarcate_toolbar_handlers()}})(jQuery)