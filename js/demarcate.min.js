/*************************************************************************
*      DemarcateJS v1.1 is an in-place Markdown editor and decoder       *
*                                                                        *
*      It was written by William Hart (http://www.williamhart.info) to   *
*      run on "textr" (http://to-textr.com/) a new Markdown enabled      *
*      platform to allow writing and sharing of online text              *
*                                                                        *
*                                                                        *
*      This code is provided under a GPLv3 License                       *
*               http://www.gnu.org/licenses/gpl-3.0.html                 *
*      It is also hosted at github:                                      *
*               http://will-hart.github.com/demarcate                    *
*      Contributions welcome.                                            *
*                                                                        *
*************************************************************************/
function modifyHtml(a){var b=$("<div/>").html(a).text(),c=RegExp("\\[(.*?)\\]\\((.*?)\\)","gi");return b=b.replace(c," <a href='$2'>$1</a> ")}function demarkdown(a,b){var d=a.get(0),e=d.nodeType,f=3==e?"_text":d.tagName.toLowerCase(),g="";if(a.hasClass("demarcate_temporary"))return g;if(!f in tag_dict)return g;if(!tag_dict[f].markdownable&&3!=e)return g;if(b&&"a"!=f||(g+=tag_dict[f].prefix),3==e){if(""==$.trim(d.nodeValue))return"";g+=$.trim(d.nodeValue)}return g+=tag_dict[f].childprefix,$.each(a.contents(),function(a,c){g+=demarkdown($(c),b,"")}),b&&"a"!=f||(g+=tag_dict[f].postfix),tag_dict[f].post_newline&&(g+="\n"),"a"==f&&(g=" "+g+"("+a.attr("href")+") "),g}function generate_toolbar(){var a=$("<div />",{id:"demarcate_toolbar"});return a.append($("<a />",{id:"demarcate_h1","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h2","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h3","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h4","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h5","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h6","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_p","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_code","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_pre","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_blockquote","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_ul","class":"demarcate_style",href:"#"})),a.append($("<p/>")),a.append($("<a />",{id:"demarcate_up","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_down","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_help","class":"demarcate_style",href:"#"})),a.append($("<p/>")),a.append($("<a />",{id:"demarcate_cancel",href:"#"})),a.append($("<a />",{id:"demarcate_save",href:"#"})),a}function toolbar_set_active(){var a="";null!=current_demarcate_element&&(a=current_demarcate_element.get(0).tagName.toLowerCase(),$(".demarcate_style").removeClass("active"),$("#demarcate_"+a).addClass("active"))}function display_editor(a){if(null!=current_demarcate_editor)return console.log("Aborting editor open - another editor is already open"),void 0;a=$(a);var b=a.get(0).tagName.toLowerCase();if(b in tag_dict){var c=demarkdown(a,!0,""),d=$("<textarea id='demarcate'></textarea>"),e=generate_toolbar();a.after(d),a.after(e),a.addClass("demarcate_hide"),current_demarcate_element=a,current_demarcate_editor=d,toolbar_set_active(),void 0!=typeof a.autosize&&d.autosize({append:"\n"}),d.focus().val($.trim(c)),$(window).resize()}}function hide_editor(a){a.preventDefault(),$("div#demarcate_toolbar").remove(),current_demarcate_editor.remove(),current_demarcate_editor=null,""===current_demarcate_element.html()?current_demarcate_element.remove():current_demarcate_element.removeClass("demarcate_hide"),current_demarcate_element=null,$(".demarcate_temporary").remove()}function demarcate_click_elsewhere_save(a){if(null!=current_demarcate_editor){var b=$("#demarcate_toolbar");current_demarcate_editor.is(a.target)||b.is(a.target)||0!==b.has(a.target).length||$("#demarcate_save").click()}}function replace_tag(a){var b=$("<"+a+"/>");current_demarcate_element.after(b),current_demarcate_element.remove(),current_demarcate_element=b,$("a#demarcate_cancel").fadeOut("fast",function(){this.remove()}),toolbar_set_active(),current_demarcate_editor.focus()}function save_and_new_editor_area(){var a=current_demarcate_element.get(0).tagName,b=$("<"+a+"/>");b.insertAfter(current_demarcate_element),$("#demarcate_save").click(),b.addClass("demarcate_temporary"),b.click()}function enable_demarcate_toolbar_handlers(){$(document).on("keydown","#demarcate",function(a){if(13==a.keyCode)a.preventDefault(),a.shiftKey?$("#demarcate_save").click():a.ctrlKey?save_and_new_editor_area():tag_dict[current_demarcate_element.get(0).tagName.toLowerCase()].allow_newline?current_demarcate_editor.insertAtCaret("\n"):save_and_new_editor_area();else if(32==a.keyCode){if(a.ctrlKey){a.preventDefault();var b=$("div#demarcate_toolbar a.active").next().filter(".demarcate_style");0!=b.length?b.click():$("div#demarcate_toolbar a.demarcate_style").first().click()}}else 27==a.keyCode?(a.preventDefault(),$("#demarcate_cancel").click()):9==a.keyCode&&(a.preventDefault(),current_demarcate_editor.insertAtCaret("    "))}),$(document).bind("mousedown",demarcate_click_elsewhere_save),$(document).on("click","#demarcate_cancel",function(a){hide_editor(a),$(document).trigger("demarcate_editor_closed",[current_demarcate_element])}),$(document).on("click","#demarcate_save",function(a){current_demarcate_element.html(modifyHtml(current_demarcate_editor.val())),current_demarcate_element.removeClass("demarcate_temporary"),hide_editor(a),$(document).trigger("demarcate_editor_closed",[current_demarcate_element])}),$(document).on("mouseover",".demarcate_style",function(a){var b=$(a.target).css("backgroundPosition").split(" ");$(a.target).css("backgroundPosition",b[0]+" "+(parseInt(b[1])-72)+"px")}),$(document).on("mouseout",".demarcate_style",function(a){var b=$(a.target).css("backgroundPosition").split(" ");$(a.target).css("backgroundPosition",b[0]+" "+(parseInt(b[1])+72)+"px")}),$(document).on("click",".demarcate_style",function(a){a.preventDefault();var b=$(this).attr("id").replace("demarcate_","");if(b in tag_dict){var c=current_demarcate_element.get(0).tagName.toLowerCase();if(current_demarcate_element.parent().get(0).tagName.toLowerCase(),"li"==c&&"ul"!=b)par=current_demarcate_element.parent(),current_demarcate_element.detach().insertAfter(par),replace_tag(b);else if("li"!=c&&"ul"==b){var e=$("<"+b+"/>");e.insertBefore(current_demarcate_element),current_demarcate_element.appendTo(e),replace_tag("li")}else replace_tag(b)}else"help"==b&&alert("SHIFT+ENTER - save your changes\nESCAPE - cancel your changes\nCTRL+ENTER - save your changes, insert a new section\nENTER - save your changes (or add new line in a code block)")}),$(document).on("click","#demarcate_down",function(a){a.preventDefault();var b=current_demarcate_editor.next(".demarcate_editable");b.length>0&&b.insertBefore(current_demarcate_element),current_demarcate_editor.focus()}),$(document).on("click","#demarcate_up",function(a){a.preventDefault();var b=current_demarcate_element.prev(".demarcate_editable");b.length>0&&b.insertAfter(current_demarcate_editor),current_demarcate_editor.focus()})}var tag_dict={div:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:"",allow_newline:!1},span:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:"",allow_newline:!1},h1:{editable:!0,markdownable:!0,prefix:"# ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},h2:{editable:!0,markdownable:!0,prefix:"## ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},h3:{editable:!0,markdownable:!0,prefix:"### ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},h4:{editable:!0,markdownable:!0,prefix:"#### ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},h5:{editable:!0,markdownable:!0,prefix:"##### ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},h6:{editable:!0,markdownable:!0,prefix:"###### ",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},li:{editable:!0,markdownable:!0,prefix:" - ",postfix:"\n",post_newline:!1,childprefix:"",allow_newline:!1},ul:{editable:!1,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},ol:{editable:!1,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},blockquote:{editable:!0,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:"> ",allow_newline:!1},pre:{editable:!0,markdownable:!0,prefix:"    ",postfix:"\n",post_newline:!0,childprefix:"    ",allow_newline:!0},code:{editable:!0,markdownable:!0,prefix:"`",postfix:"`",post_newline:!1,childprefix:"",allow_newline:!1},a:{editable:!1,markdownable:!0,prefix:" [",postfix:"]",post_newline:!1,childprefix:"",allow_newline:!1},hr:{editable:!1,markdownable:!0,prefix:"------",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},em:{editable:!1,markdownable:!0,prefix:" *",postfix:"* ",post_newline:!1,childprefix:"",allow_newline:!1},strong:{editable:!1,markdownable:!0,prefix:" **",postfix:"** ",post_newline:!1,childprefix:"",allow_newline:!1},p:{editable:!0,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:"",allow_newline:!1},_text:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:"",allow_newline:!1}};(function(a){a.fn.demarcate=function(){return result=demarkdown(this,!1,""),a(document).trigger("demarcation_complete",[result]),result}})(jQuery),function(a){a.fn.enable_demarcate=function(){window.demarcate_dom_root=a(this),window.current_demarcate_editor=null,window.current_demarcate_element=null,a(this).addClass("demarcate_sortable");for(var b in tag_dict)tag_dict[b].editable&&(live_selector="#"+this.attr("id")+" "+b,a(document).on("click",live_selector,function(b){a("#demarcate_toolbar").has(b.target).length>0||a("#demarcate_toolbar").is(b.target)||"demarcate"===a(this).attr("id")||display_editor(this)}),a(live_selector).addClass("demarcate_editable"),a(document).on("DOMNodeInserted",live_selector,function(b){a(b.target).addClass("demarcate_editable")}));enable_demarcate_toolbar_handlers(),(demarcate_dom_root.is(":empty")||""==a.trim(demarcate_dom_root.html()))&&demarcate_dom_root.append(a("<p />",{"class":"demarcate_temporary",text:"Click me to start editing"}))}}(jQuery),function(a){a.fn.insertAtCaret=function(a){var b=this.val().replace(/\r\n/g,"\n"),c=this.get(0).selectionStart,d=this.get(0).selectionEnd,e=b.substring(0,c)+a+b.substring(d);this.val(e.replace(/\n/g,"\r\n"))}}(jQuery);