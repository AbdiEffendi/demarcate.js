/*************************************************************************
*      DemarcateJS v1.1 is an in-place Markdown editor and decoder       *
*                                                                        *
*      It was written by William Hart (http://www.williamhart.info) to   *
*      run on "textr" (http://to-textr.com/) a new Markdown enabled      *
*      platform to allow writing and sharing of online text              *
*                                                                        *
*                                                                        *
*      This code is provided under a GPLv3 License                       *
*               http://www.gnu.org/licenses/gpl-3.0.html                 *
*      It is also hosted at github:                                      *
*               http://will-hart.github.com/demarcate                    *
*      Contributions welcome.                                            *
*                                                                        *
*************************************************************************/


var tag_dict;function modifyHtml(a){var b=$("<div/>").html(a).text(),c=new RegExp("\\[(.*?)\\]\\((.*?)\\)","gi");return b=b.replace(c,"<a href='$2'>$1</a>"),b}function demarkdown(a,b,c){var d=a.get(0),e=d.nodeType,f=e==3?"_text":d.tagName.toLowerCase(),g="";if(a.hasClass("demarcate_temporary"))return g;if(!f in tag_dict)return g;if(!tag_dict[f].markdownable&&e!=3)return g;if(!b||f=="a")g+=c+tag_dict[f].prefix;if(e==3){if($.trim(d.nodeValue)=="")return"";g+=$.trim(d.nodeValue)}$.each(a.contents(),function(a,c){g+=demarkdown($(c),b,tag_dict[f].childprefix)});if(!b||f=="a")g+=tag_dict[f].postfix;return tag_dict[f].post_newline&&(g+="\n"),f=="a"&&(g=" "+g+"("+a.attr("href")+") "),g}function generate_toolbar(){var a=$("<div />",{id:"demarcate_toolbar"});return a.append($("<a />",{id:"demarcate_h1","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h2","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h3","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h4","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h5","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_h6","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_p","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_code","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_blockquote","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_ul","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_cancel",href:"#"})),a.append($("<a />",{id:"demarcate_save",href:"#"})),a.append($("<a />",{id:"demarcate_up","class":"demarcate_style",href:"#"})),a.append($("<a />",{id:"demarcate_down","class":"demarcate_style",href:"#"})),a}function toolbar_set_active(){var a="";if(current_demarcate_element==null)return;a=current_demarcate_element.get(0).tagName.toLowerCase(),$(".demarcate_style").removeClass("active"),$("#demarcate_"+a).addClass("active")}function display_editor(a){var b,c,d,e;a=$(a);b=a.get(0).tagName.toLowerCase();if(b in tag_dict){c=demarkdown(a,!0,""),d=$("<textarea id='demarcate'></textarea>"),e=generate_toolbar();a.after(d),a.after(e),a.addClass("demarcate_hide"),current_demarcate_element=a,current_demarcate_editor=d,toolbar_set_active(),typeof a.autosize!=undefined&&d.autosize({append:"\n"}),d.focus().val($.trim(c))}}function hide_editor(a){a.preventDefault(),$("div#demarcate_toolbar").remove(),current_demarcate_editor.remove(),current_demarcate_editor=null,current_demarcate_element.html()===""?current_demarcate_element.remove():current_demarcate_element.removeClass("demarcate_hide"),current_demarcate_element=null,$(".demarcate_temporary").remove()}function demarcate_click_elsewhere_save(a){var b;if(current_demarcate_editor==null)return;b=$("#demarcate_toolbar");!current_demarcate_editor.is(a.target)&&!b.is(a.target)&&b.has(a.target).length===0&&$("#demarcate_save").click()}function replace_tag(a){var b=$("<"+a+"/>");current_demarcate_element.after(b),current_demarcate_element.remove(),current_demarcate_element=b,$("a#demarcate_cancel").fadeOut("fast",function(){this.remove()}),toolbar_set_active(),current_demarcate_editor.focus()}function enable_demarcate_toolbar_handlers(){$(document).on("keydown","#demarcate",function(a){var b,c,d;if(a.keyCode==13){a.preventDefault();if(a.shiftKey)$("#demarcate_save").click();else{b=current_demarcate_element.get(0).tagName,c=$("<"+b+"/>");c.insertAfter(current_demarcate_element),$("#demarcate_save").click(),c.addClass("demarcate_temporary"),c.click()}}else if(a.keyCode==32){if(a.ctrlKey){a.preventDefault();d=$("div#demarcate_toolbar a.active").next().filter(".demarcate_style");d.length!=0?d.click():$("div#demarcate_toolbar a.demarcate_style").first().click()}}else a.keyCode==27&&(a.preventDefault(),$("#demarcate_cancel").click())}),$(document).bind("mousedown",demarcate_click_elsewhere_save),$(document).on("click","#demarcate_cancel",function(a){hide_editor(a),$(document).trigger("demarcate_editor_closed",[current_demarcate_element])}),$(document).on("click","#demarcate_save",function(a){current_demarcate_element.html(modifyHtml(current_demarcate_editor.val())),current_demarcate_element.removeClass("demarcate_temporary"),hide_editor(a),$(document).trigger("demarcate_editor_closed",[current_demarcate_element])}),$(document).on("mouseover",".demarcate_style",function(a){var b=$(a.target).css("backgroundPosition").split(" ");$(a.target).css("backgroundPosition",b[0]+" "+(parseInt(b[1])-96)+"px")}),$(document).on("mouseout",".demarcate_style",function(a){var b=$(a.target).css("backgroundPosition").split(" ");$(a.target).css("backgroundPosition",b[0]+" "+(parseInt(b[1])+96)+"px")}),$(document).on("click",".demarcate_style",function(a){var b,c,d,e;a.preventDefault();b=$(this).attr("id").replace("demarcate_","");if(b in tag_dict){c=current_demarcate_element.get(0).tagName.toLowerCase(),d=current_demarcate_element.parent().get(0).tagName.toLowerCase();if(c=="li"&&b!="ul")par=current_demarcate_element.parent(),current_demarcate_element.detach().insertBefore(par),replace_tag(b);else if(c!="li"&&b=="ul"){e=$("<"+b+"/>");e.insertBefore(current_demarcate_element),current_demarcate_element.appendTo(e),replace_tag("li")}else replace_tag(b)}}),$(document).on("click","#demarcate_down",function(a){var b;a.preventDefault();b=current_demarcate_editor.next(".demarcate_editable");b.length>0&&b.insertBefore(current_demarcate_element)}),$(document).on("click","#demarcate_up",function(a){var b;a.preventDefault();b=current_demarcate_element.prev(".demarcate_editable");b.length>0&&b.insertAfter(current_demarcate_editor)})}tag_dict={div:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:""},span:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:""},h1:{editable:!0,markdownable:!0,prefix:"#",postfix:"\n",post_newline:!0,childprefix:""},h2:{editable:!0,markdownable:!0,prefix:"##",postfix:"\n",post_newline:!0,childprefix:""},h3:{editable:!0,markdownable:!0,prefix:"###",postfix:"\n",post_newline:!0,childprefix:""},h4:{editable:!0,markdownable:!0,prefix:"####",postfix:"\n",post_newline:!0,childprefix:""},h5:{editable:!0,markdownable:!0,prefix:"#####",postfix:"\n",post_newline:!0,childprefix:""},h6:{editable:!0,markdownable:!0,prefix:"######",postfix:"\n",post_newline:!0,childprefix:""},li:{editable:!0,markdownable:!0,prefix:"",postfix:"\n",post_newline:!1,childprefix:" - "},ul:{editable:!1,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:""},ol:{editable:!1,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:""},blockquote:{editable:!0,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:">"},pre:{editable:!0,markdownable:!0,prefix:"    ",postfix:"\n",post_newline:!0,childprefix:"    "},code:{editable:!0,markdownable:!0,prefix:"`",postfix:"`",post_newline:!1,childprefix:""},a:{editable:!1,markdownable:!0,prefix:"[",postfix:"]",post_newline:!1,childprefix:""},hr:{editable:!1,markdownable:!0,prefix:"------",postfix:"\n",post_newline:!0,childprefix:""},em:{editable:!1,markdownable:!0,prefix:"*",postfix:"*",post_newline:!1,childprefix:""},strong:{editable:!1,markdownable:!0,prefix:"**",postfix:"**",post_newline:!1,childprefix:""},p:{editable:!0,markdownable:!0,prefix:"",postfix:"\n",post_newline:!0,childprefix:""},_text:{editable:!1,markdownable:!0,prefix:"",postfix:"",post_newline:!1,childprefix:""}};(function(a){a.fn.demarcate=function(){return result=demarkdown(this,!1,""),a(document).trigger("demarcation_complete",[result]),result}})(jQuery),function(a){a.fn.enable_demarcate=function(){var b;window.demarcate_dom_root=a(this),window.current_demarcate_editor=null,window.current_demarcate_element=null,a(this).addClass("demarcate_sortable");for(b in tag_dict)tag_dict[b].editable&&(live_selector="#"+this.attr("id")+" "+b,a(document).on("click",live_selector,function(b){if(a("#demarcate_toolbar").has(b.target).length>0||a("#demarcate_toolbar").is(b.target)||a(this).attr("id")==="demarcate")return;display_editor(this)}),a(live_selector).addClass("demarcate_editable"),a(document).on("DOMNodeInserted",live_selector,function(b){a(b.target).addClass("demarcate_editable")}));enable_demarcate_toolbar_handlers(),(demarcate_dom_root.is(":empty")||a.trim(demarcate_dom_root.html())=="")&&demarcate_dom_root.append(a("<p />",{"class":"demarcate_temporary",text:"Click me to start editing"}))}}(jQuery)